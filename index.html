<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVR Gold | Master Offline</title>
    <style>
        :root { --gold: #D4AF37; --bg: #050505; --card-bg: #111; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; height: 100%; }
        
        #booking-page { display: flex; flex-direction: column; align-items: center; padding: 30px 20px; box-sizing: border-box; min-height: 100vh; }
        .container { width: 100%; max-width: 400px; text-align: center; }

        h1 { color: var(--gold); text-transform: uppercase; letter-spacing: 6px; font-size: 22px; cursor: pointer; }

        /* Balance & Inputs */
        .balance-card { background: rgba(212,175,55,0.05); border: 1px solid rgba(212,175,55,0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .balance-value { font-size: 18px; color: var(--gold); font-weight: bold; }
        
        .movie-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .movie-option { background: #111; border: 1px solid #333; padding: 12px; border-radius: 10px; cursor: pointer; color: #888; font-weight: bold; }
        .movie-option.selected { border-color: var(--gold); background: rgba(212,175,55,0.1); color: var(--gold); }

        .input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; background: #111; border: 1px solid #222; border-radius: 8px; color: white; outline: none; }

        .confirm-btn { width: 100%; padding: 18px; background: var(--gold); color: black; border: none; border-radius: 12px; font-weight: bold; text-transform: uppercase; cursor: pointer; font-size: 16px; margin-top: 10px; }
        
        /* Wallet List */
        .ticket-bar { background: #161616; border-left: 4px solid var(--gold); padding: 15px; border-radius: 8px; margin-top: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .ticket-bar:active { transform: scale(0.98); }

        /* Overlays */
        #ticket-page, #scanner-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; color: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #scanner-page { background: #000; color: #fff; }

        .qr-seal { padding: 20px; border: 4px double var(--gold); border-radius: 20px; background: white; margin-bottom: 20px; }
        #reader { width: 300px; border-radius: 20px; overflow: hidden; border: 2px solid var(--gold); }
        
        .reset-link { margin-top: 30px; font-size: 10px; color: #444; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

<div id="booking-page">
    <div class="container">
        <h1 onclick="openScanner()">PVR GOLD</h1>

        <div class="balance-card">
            <div class="balance-value" id="balanceText">100 Points</div>
        </div>

        <div class="movie-grid">
            <div class="movie-option" onclick="selectMovie('Avatar 2', this)">Avatar 2</div>
            <div class="movie-option" onclick="selectMovie('The Batman', this)">The Batman</div>
            <div class="movie-option" onclick="selectMovie('Gladiator II', this)">Gladiator II</div>
            <div class="movie-option" onclick="selectMovie('Animal', this)">Animal</div>
        </div>

        <div class="input-row">
            <input type="number" id="seats" value="1" min="1" placeholder="Seats">
            <input type="time" id="startTime" value="19:00">
        </div>

        <button class="confirm-btn" onclick="bookNow()">Book Ticket</button>
        
        <div id="ticket-list" style="width:100%; text-align:left;"></div>
        
        <div class="reset-link" onclick="hardReset()">Reset All Data</div>
    </div>
</div>

<div id="ticket-page">
    <div style="font-weight: 900; color: var(--gold); font-size: 24px; margin-bottom: 10px;">PREMIUM PASS</div>
    <div style="font-size: 12px; color: #555; margin-bottom: 20px;">Present this QR at the gate</div>
    <div class="qr-seal"><div id="qrcode"></div></div>
    <div id="ticket-details" style="text-align: center; font-weight:bold; font-size: 18px;"></div>
    <button class="confirm-btn" style="width:200px; margin-top:30px;" onclick="closeTicket()">Close</button>
</div>

<div id="scanner-page">
    <h2 style="color:var(--gold)">GATE SCANNER</h2>
    <div style="font-size: 11px; color: #888; margin-bottom: 10px;">Align QR code within the frame</div>
    <div id="reader"></div>
    <button onclick="closeScanner()" style="margin-top:20px; color:white; background:none; border:1px solid #333; padding:10px 30px; border-radius: 50px;">Cancel Scan</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    // --- INIT ---
    let balance = parseInt(localStorage.getItem('pvr_balance')) || 500;
    let tickets = JSON.parse(localStorage.getItem('pvr_tickets')) || [];
    let selectedMovieName = "";

    window.onload = () => { updateUI(); renderWallet(); };

    // --- BOOKING LOGIC ---
    function selectMovie(name, el) { 
        selectedMovieName = name; 
        document.querySelectorAll('.movie-option').forEach(opt => opt.classList.remove('selected')); 
        el.classList.add('selected'); 
    }

    function bookNow() {
        if(!selectedMovieName) return alert("Please select a movie.");
        const s = document.getElementById('seats').value;
        const t = document.getElementById('startTime').value;
        const cost = s * 100;
        
        if(balance < cost) return alert("Insufficient Balance!");
        
        balance -= cost;
        
        // 1. Generate SIMPLE 5-Digit ID (String)
        const id = Math.floor(10000 + Math.random() * 90000).toString();
        
        // 2. Add to Wallet
        tickets.push({ id: id, movie: selectedMovieName, seats: s, time: t });
        
        // 3. Save
        saveData();
        updateUI(); 
        renderWallet(); 
        
        // 4. Open the Ticket immediately
        openExistingTicket(tickets.length - 1);
    }

    function renderWallet() {
        const list = document.getElementById('ticket-list');
        list.innerHTML = "";
        tickets.forEach((t, i) => {
            list.innerHTML += `<div class="ticket-bar" onclick="openExistingTicket(${i})">
                <div>
                    <div style="color:var(--gold); font-weight:bold; font-size:14px;">${t.movie}</div>
                    <div style="font-size:12px; color:#888;">${t.time} • ${t.seats} Seats</div>
                </div>
                <div style="font-family:monospace; font-weight:bold; font-size:16px;">#${t.id}</div>
            </div>`;
        });
    }

    function updateUI() {
        document.getElementById('balanceText').innerText = balance + " Points";
    }
    
    function saveData() {
        localStorage.setItem('pvr_balance', balance);
        localStorage.setItem('pvr_tickets', JSON.stringify(tickets));
    }

    // --- TICKET VIEW ---
    function openExistingTicket(i) {
        const t = tickets[i];
        document.getElementById('ticket-details').innerHTML = `${t.movie}<br><span style="color:#555">ID: #${t.id}</span>`;
        document.getElementById("qrcode").innerHTML = "";
        // QR Code ONLY holds the ID number
        new QRCode(document.getElementById("qrcode"), { text: t.id, width: 200, height: 200 });
        document.getElementById('ticket-page').style.display = 'flex';
    }
    function closeTicket() { document.getElementById('ticket-page').style.display = 'none'; }

    // --- SCANNER LOGIC (ROBUST) ---
    let scanner;
    function openScanner() {
        document.getElementById('scanner-page').style.display = 'flex';
        scanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
        scanner.render(onScanSuccess);
    }

    function onScanSuccess(decodedText) {
        // 1. Clean the input (remove spaces, ensure string)
        const scannedID = decodedText.trim();
        console.log("Looking for ID:", scannedID);

        // 2. Find Ticket
        const index = tickets.findIndex(t => t.id === scannedID);

        if (index !== -1) {
            const movie = tickets[index].movie;
            
            // 3. REMOVE TICKET (Success)
            tickets.splice(index, 1);
            saveData();
            
            // 4. Close and Alert
            scanner.clear();
            document.getElementById('scanner-page').style.display = 'none';
            alert(`✅ ACCESS GRANTED\nMovie: ${movie}\nTicket #${scannedID} redeemed.`);
            renderWallet();
        } else {
            // 5. Fail (only if ID doesn't exist)
            alert(`❌ INVALID TICKET\nID #${scannedID} not found in wallet.`);
        }
    }

    function closeScanner() { if(scanner) scanner.clear(); document.getElementById('scanner-page').style.display = 'none'; }
    
    function hardReset() {
        if(confirm("Factory Reset: Clear all tickets and restore 500 points?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>
</body>
</html>
