<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PVR Gold | Final Fix</title>
    <style>
        :root { --gold: #D4AF37; --bg: #050505; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; text-align: center; }
        .container { padding: 20px; max-width: 400px; margin: auto; }
        h1 { color: var(--gold); letter-spacing: 4px; cursor: pointer; }
        
        .card { background: #111; border: 1px solid #333; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .movie-opt { display: inline-block; padding: 10px; border: 1px solid #444; margin: 5px; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .selected { border-color: var(--gold); color: var(--gold); background: rgba(212,175,55,0.1); }
        
        input { width: 80%; padding: 10px; margin: 10px 0; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        .btn { width: 100%; padding: 15px; background: var(--gold); color: black; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        .ticket-item { background: #161616; border-left: 4px solid var(--gold); padding: 15px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; border-radius: 5px; cursor: pointer; }
        
        /* Overlays */
        #ticket-view, #scanner-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; color: black; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        #scanner-view { background: black; color: white; }
        #reader { width: 300px; border: 2px solid var(--gold); border-radius: 15px; overflow: hidden; }
    </style>
</head>
<body>

<div class="container">
    <h1 onclick="openScanner()">PVR GOLD</h1>
    
    <div class="card">
        <div id="balanceDisplay">Balance: 500</div>
    </div>

    <div class="card">
        <div class="movie-opt" onclick="selMovie('Avatar', this)">Avatar</div>
        <div class="movie-opt" onclick="selMovie('Batman', this)">Batman</div>
        <div class="movie-opt" onclick="selMovie('Animal', this)">Animal</div>
        <input type="time" id="timeInput" value="18:00">
        <button class="btn" onclick="book()">BOOK TICKET</button>
    </div>

    <div id="wallet"></div>
</div>

<div id="ticket-view">
    <h2 style="color:var(--gold)">PREMIUM PASS</h2>
    <div id="qrcode"></div>
    <div id="t-info" style="margin-top:20px; font-weight:bold;"></div>
    <button class="btn" style="width:200px; margin-top:20px;" onclick="document.getElementById('ticket-view').style.display='none'">CLOSE</button>
</div>

<div id="scanner-view">
    <h1>SCANNING...</h1>
    <div id="reader"></div>
    <button class="btn" style="width:200px; margin-top:20px; background:#333; color:white;" onclick="closeScanner()">CANCEL</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    let tickets = JSON.parse(localStorage.getItem('pvr_storage')) || [];
    let balance = 500;
    let selectedMovie = "";

    function selMovie(m, el) {
        selectedMovie = m;
        document.querySelectorAll('.movie-opt').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
    }

    function book() {
        if(!selectedMovie) return alert("Select Movie");
        // Create a unique 6-digit ID
        const id = Math.floor(100000 + Math.random() * 900000).toString();
        const time = document.getElementById('timeInput').value;
        
        tickets.push({ id, movie: selectedMovie, time });
        localStorage.setItem('pvr_storage', JSON.stringify(tickets));
        render();
        showTicket(tickets.length - 1);
    }

    function render() {
        const w = document.getElementById('wallet');
        w.innerHTML = "";
        tickets.forEach((t, i) => {
            w.innerHTML += `<div class="ticket-item" onclick="showTicket(${i})">
                <span><b>${t.movie}</b> (${t.time})</span>
                <span style="color:var(--gold)">#${t.id}</span>
            </div>`;
        });
    }

    function showTicket(i) {
        const t = tickets[i];
        document.getElementById('t-info').innerText = t.movie + " | ID: " + t.id;
        document.getElementById('qrcode').innerHTML = "";
        
        // FORCE THE QR CODE TO BE ONLY THE ID NUMBER
        new QRCode(document.getElementById("qrcode"), {
            text: t.id,
            width: 250,
            height: 250,
            correctLevel : QRCode.CorrectLevel.H
        });
        document.getElementById('ticket-view').style.display = 'flex';
    }

    let scanner;
    function openScanner() {
        document.getElementById('scanner-view').style.display = 'flex';
        scanner = new Html5QrcodeScanner("reader", { fps: 20, qrbox: 250 });
        scanner.render((text) => {
            const scannedId = text.trim();
            // Check if ID is in our list
            const idx = tickets.findIndex(t => t.id === scannedId);
            
            if(idx !== -1) {
                const m = tickets[idx].movie;
                tickets.splice(idx, 1);
                localStorage.setItem('pvr_storage', JSON.stringify(tickets));
                scanner.clear();
                document.getElementById('scanner-view').style.display = 'none';
                render();
                alert("✅ VERIFIED: " + m + "\nTicket used successfully.");
            } else {
                alert("❌ INVALID ID: " + scannedId);
            }
        });
    }

    function closeScanner() {
        if(scanner) scanner.clear();
        document.getElementById('scanner-view').style.display = 'none';
    }

    render();
</script>
</body>
</html>
